class MusicianSite{constructor(){this.navbar=document.getElementById('navbar');this.hamburger=document.getElementById('hamburger');this.navMenu=document.getElementById('nav-menu');this.videoModal=document.getElementById('video-modal');this.modalVideo=document.getElementById('modal-video');this.heroVideo=document.getElementById('hero-video');this.videoPlayBtn=document.getElementById('video-play-btn');this.contactForm=document.getElementById('contact-form');this.init()}init(){this.setupNavigation();this.setupScrollEffects();this.setupVideoHandlers();this.setupContactForm();this.setupTestimonialsCarousel();this.setupAnimations();this.setupSmoothScrolling();this.setupParallaxOptimizations()}setupNavigation(){this.hamburger.addEventListener('click',()=>{this.navMenu.classList.toggle('active');this.hamburger.classList.toggle('active')});document.querySelectorAll('.nav-link').forEach(link=>{link.addEventListener('click',()=>{this.navMenu.classList.remove('active');this.hamburger.classList.remove('active')})});document.addEventListener('click',(e)=>{if (!this.navMenu.contains(e.target)&&!this.hamburger.contains(e.target)){this.navMenu.classList.remove('active');this.hamburger.classList.remove('active')}})}setupScrollEffects(){let lastScrollY=window.scrollY;const hero=document.querySelector('.hero');const heroOverlay=document.querySelector('.hero-overlay');const parallaxLayers=document.querySelectorAll('.parallax-layer');let ticking=false;let heroVisible=true;const observer=new IntersectionObserver((entries)=>{entries.forEach(entry=>{heroVisible=entry.isIntersecting})},{rootMargin:'100px 0px'});if (hero)observer.observe(hero);const updateParallax=()=>{const currentScrollY=window.scrollY;if (currentScrollY>100){this.navbar.classList.add('scrolled')}else{this.navbar.classList.remove('scrolled')}if (hero&&heroVisible&&currentScrollY<window.innerHeight*1.2){parallaxLayers.forEach(layer=>{const speed=parseFloat(layer.dataset.speed)||0;const yPos=currentScrollY*speed;layer.style.transform=`translate3d(0,${yPos}px,0)`});if (heroOverlay){heroOverlay.style.transform=`translate3d(0,${currentScrollY*0.4}px,0)`}}this.updateActiveNavLink();lastScrollY=currentScrollY;ticking=false};const requestTick=()=>{if (!ticking){requestAnimationFrame(updateParallax);ticking=true}};window.addEventListener('scroll',requestTick,{passive:true});updateParallax()}updateActiveNavLink(){const sections=document.querySelectorAll('section[id]');const scrollPos=window.scrollY+100;sections.forEach(section=>{const sectionTop=section.offsetTop;const sectionHeight=section.offsetHeight;const sectionId=section.getAttribute('id');const navLink=document.querySelector(`.nav-link[href="#${sectionId}"]`);if (scrollPos>=sectionTop&&scrollPos<sectionTop+sectionHeight){document.querySelectorAll('.nav-link').forEach(link=>{link.classList.remove('active')});if (navLink){navLink.classList.add('active')}}})}setupVideoHandlers(){document.querySelectorAll('.play-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{e.preventDefault();const videoSrc=btn.getAttribute('data-video');this.openVideoModal(videoSrc)})});const closeBtn=document.querySelector('.video-modal-close');if (closeBtn){closeBtn.addEventListener('click',()=>{this.closeVideoModal()})}if (this.videoModal){this.videoModal.addEventListener('click',(e)=>{if (e.target===this.videoModal){this.closeVideoModal()}})}document.addEventListener('keydown',(e)=>{if (e.key==='Escape'){this.closeVideoModal()}});window.addEventListener('popstate',(e)=>{if (this.videoModal&&this.videoModal.style.display==='block'){this.closeVideoModal(true)}})}openVideoModal(videoSrc,isRoute=false){if (this.videoModal&&this.modalVideo){this.modalVideo.src=videoSrc;this.videoModal.style.display='block';document.body.style.overflow='hidden';if (!isRoute){history.pushState({modalOpen:true},'','')}setTimeout(()=>{this.modalVideo.play().catch (e=>{console.log('Auto-play prevented:',e)})},100)}}closeVideoModal(skipHistoryChange=false){if (this.videoModal&&this.modalVideo){this.videoModal.style.display='none';this.modalVideo.pause();this.modalVideo.src='';document.body.style.overflow='auto';const path=window.location.pathname;const isVideoRoute=path.match(/^\/video\/(.+)$/);if (isVideoRoute){window.history.pushState(null,'שירה בציבור מקצועית|אלון כהן-קלידן ומוביל שירה','/');document.title='שירה בציבור מקצועית|אלון כהן-קלידן ומוביל שירה';const canonicalTag=document.querySelector('link[rel="canonical"]');if (canonicalTag){canonicalTag.href='https://singwithalon.com/'}}else if (!skipHistoryChange&&window.history.state&&window.history.state.modalOpen){history.back()}}}setupContactForm(){if (this.contactForm){this.contactForm.addEventListener('submit',(e)=>{e.preventDefault();this.handleFormSubmission()})}}async handleFormSubmission(){const formData=new FormData(this.contactForm);const data=Object.fromEntries(formData);const errors=FormValidator.validateForm(data);if (errors.length>0){this.showMessage(errors.join('\n'),'error');return}const submitBtn=this.contactForm.querySelector('button[type="submit"]');const originalText=submitBtn.innerHTML;submitBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i>יוצר הודעה...';submitBtn.disabled=true;try{await this.sendWhatsAppMessage(data)}catch (error){console.error('WhatsApp message error:',error);this.showMessage('שגיאה ביצירת הודעת WhatsApp. אנא נסו שוב.','error')}finally{submitBtn.innerHTML=originalText;submitBtn.disabled=false}}async sendWhatsAppMessage(data){const formattedDate=data.date ? new Date(data.date).toLocaleDateString('he-IL'):'לא צוין';const message=`שלום אלון!🎵 אני מעוניין/ת להזמין מופע:👤 שם:${data.name}📞 טלפון:${data.phone}📅 תאריך מועדף:${formattedDate}💬 פרטים נוספים:${data.message||'לא צוינו פרטים נוספים'}אשמח לשמוע ממך בהקדם!🎶`;const encodedMessage=encodeURIComponent(message);const phoneNumber='972528962110';const whatsappUrl=`https://wa.me/${phoneNumber}?text=${encodedMessage}`;await new Promise(resolve=>setTimeout(resolve,1000));try{const newWindow=window.open(whatsappUrl,'_blank','noopener,noreferrer');if (!newWindow||newWindow.closed||typeof newWindow.closed=='undefined'){window.location.href=whatsappUrl}else{this.showMessage('הודעת WhatsApp נוצרה בהצלחה!הדפדפן ייפתח בעוד רגע.','success');this.contactForm.reset()}}catch (error){console.log('Popup failed,using direct navigation:',error);window.location.href=whatsappUrl}return true}showMessage(message,type){const existingMessages=document.querySelectorAll('.form-message');existingMessages.forEach(msg=>msg.remove());const messageEl=document.createElement('div');messageEl.className=`form-message ${type}`;messageEl.innerHTML=`<i class="fas fa-${type==='success' ? 'check-circle':'exclamation-circle'}"></i><span>${message}</span>`;messageEl.style.cssText=` display:flex;align-items:center;gap:10px;padding:15px 20px;margin-top:20px;border-radius:10px;font-weight:500;background:${type==='success' ? '#d4edda':'#f8d7da'};color:${type==='success' ? '#155724':'#721c24'};border:1px solid ${type==='success' ? '#c3e6cb':'#f5c6cb'};`;this.contactForm.appendChild(messageEl);setTimeout(()=>{messageEl.remove()},5000)}setupTestimonialsCarousel(){const carousel=document.querySelector('.testimonials-carousel');if (carousel){this.testimonialsCarousel=new TestimonialsCarousel(carousel)}}setupAnimations(){const observerOptions={threshold:0.1,rootMargin:'0px 0px-50px 0px'};const observer=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if (entry.isIntersecting){entry.target.classList.add('visible')}})},observerOptions);document.querySelectorAll('.service-card,.testimonial-card,.video-card,.highlight-item').forEach(el=>{el.classList.add('fade-in');observer.observe(el)});document.querySelectorAll('.services-grid .service-card').forEach((card,index)=>{card.style.animationDelay=`${index*0.2}s`});document.querySelectorAll('.testimonials-grid .testimonial-card').forEach((card,index)=>{card.style.animationDelay=`${index*0.2}s`});document.querySelectorAll('.videos-grid .video-card').forEach((card,index)=>{card.style.animationDelay=`${index*0.1}s`})}setupSmoothScrolling(){document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener('click',(e)=>{e.preventDefault();const targetId=anchor.getAttribute('href');const targetSection=document.querySelector(targetId);if (targetSection){const offsetTop=targetSection.offsetTop-80;window.scrollTo({top:offsetTop,behavior:'smooth'})}})});const scrollIndicator=document.querySelector('.scroll-indicator');if (scrollIndicator){scrollIndicator.addEventListener('click',()=>{const aboutSection=document.getElementById('about');if (aboutSection){aboutSection.scrollIntoView({behavior:'smooth',block:'start'})}})}}setupParallaxOptimizations(){const isLowEndDevice=()=>{return navigator.hardwareConcurrency<=4||window.devicePixelRatio<1.5||/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)};if (isLowEndDevice()){document.querySelectorAll('.parallax-layer').forEach(layer=>{layer.style.filter='none'})}document.addEventListener('visibilitychange',()=>{const parallaxLayers=document.querySelectorAll('.parallax-layer');if (document.hidden){parallaxLayers.forEach(layer=>{layer.style.willChange='auto'})}else{parallaxLayers.forEach(layer=>{layer.style.willChange='transform'})}});const heroObserver=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if (entry.isIntersecting){document.body.classList.add('parallax-active')}else{document.body.classList.remove('parallax-active')}})},{threshold:0.1});const hero=document.querySelector('.hero');if (hero){heroObserver.observe(hero)}}debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}throttle(func,limit){let inThrottle;return function (){const args=arguments;const context=this;if (!inThrottle){func.apply(context,args);inThrottle=true;setTimeout(()=>inThrottle=false,limit)}}}}class FormValidator{static validateEmail(email){const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return re.test(email)}static validatePhone(phone){const re=/^(\+972|0)([23489]|5[02468]|77)[0-9]{7}$/;return re.test(phone.replace(/[-]/g,''))}static validateForm(formData){const errors=[];if (!formData.name||formData.name.length<2){errors.push('שם מלא חייב להכיל לפחות 2 תווים')}if (!FormValidator.validatePhone(formData.phone)){errors.push('מספר טלפון לא תקין')}if (!formData.date){errors.push('יש לבחור תאריך')}else{const selectedDate=new Date(formData.date);const today=new Date();today.setHours(0,0,0,0);if (selectedDate<today){errors.push('התאריך חייב להיות היום או בעתיד')}}return errors}}class PerformanceUtils{static lazyLoadImages(){if ('IntersectionObserver' in window){const imageObserver=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if (entry.isIntersecting){const img=entry.target;img.src=img.dataset.src;img.classList.remove('lazy');observer.unobserve(img)}})});document.querySelectorAll('img[data-src]').forEach(img=>{imageObserver.observe(img)})}}static preloadCriticalImages(){}}const testimonialsData=[{stars:5,text:"המערכת של בחירת השירים פשוט גאונית!כל האורחים בחרו את השירים שהם הכי אוהבים והאווירה הייתה מדהימה. אלון יודע בדיוק איך לקרוא את הקהל ולהתאים את עצמו למצב הרוח. הקלידים שלו פשוט קסומים!",author:"משפחת גולדשטיין",event:"אירוע בקיבוץ"},{stars:5,text:"הזמנו את אלון ליום הולדת 65 של אמא. הוא הביא את כל שירי ארץ ישראל הישנים שאמא כל כך אוהבת-שלמה ארצי,יהורם גאון,הדודאים. הכל היה מושלם!האווירה הייתה חמה ונוסטלגית בדיוק כמו שרצינו.",author:"משפחת רוזנברג",event:"מסיבת יום הולדת פרטית"},{stars:5,text:"זה פשוט לא להאמין איך אלון הצליח ליצור תחושה של להקה שלמה לגמרי לבד!הקלידים,הגיטרה,התופים-הכל בסינכרון מושלם. ובנוסף הוא גם הנחה את הערב בצורה כל כך כייפית. ממליצים בחום!",author:"מרים ויעקב אבני",event:"אירוע משפחתי קטן"},{stars:5,text:"הזמנו את אלון לאירוע השנתי של החברה שלנו. מה שהכי הפתיע אותנו זה איך הוא הצליח לחבר בין הדורות-הצעירים שרו עם המבוגרים באותה התלהבות. המערכת הדיגיטלית שלו מאפשרת לכל אחד לתרום לאווירה. בסוף כולם ביקשו לדעת מתי האירוע הבא!",author:"צוות שימור לקוחות,ויזה כאל",event:"אירוע חברה-60 משתתפים"},{stars:5,text:"בטקס יום הזיכרון שלנו אלון הביא בדיוק את מה שרצינו-ליווי פסנתר רגיש וחם שהתאים בצורה מושלמת לכל זמר וזמרת בהתאם לסגנון ולאופי הייחודי של כל אחד. הוא הצליח ליצור אווירה מרגשת ומכובדת,ובאותו הזמן,כשזה הגיע לשלב שירי הקהל,הוא הוביל אותנו עם הזמר שלו בצורה מרוממת שחיברה את כולם ויצרה רגש אמיתי של אחדות וזיכרון.",author:"קהילת ״בני ברית״,רמת גן",event:"טקס יום הזיכרון"}];class TestimonialsCarousel{constructor(container,options={}){this.container=container;this.track=container.querySelector('.carousel-track');this.prevBtn=container.querySelector('.carousel-btn.prev');this.nextBtn=container.querySelector('.carousel-btn.next');this.currentIndex=0;this.totalCards=testimonialsData.length;this.isRTL=document.dir==='rtl';this.isAnimating=false;this.autoAdvance=options.autoAdvance ?? true;this.interval=options.interval ?? 7000;this.autoplayTimer=null;this.mobileBreakpoint=768;this.allCards=[];this.cardWidth=0;this.visibleCards=3;this.init()}init(){this.setupEventListeners();this.checkReducedMotion();this.createAllCards();this.updateLayout();this.setupAccessibility();if (this.autoAdvance){this.startAutoplay()}window.addEventListener('resize',this.debounce(()=>{this.updateLayout()},300))}checkReducedMotion(){this.prefersReducedMotion=window.matchMedia('(prefers-reduced-motion:reduce)').matches}setupEventListeners(){this.prevBtn?.addEventListener('click',()=>this.goToPrevious());this.nextBtn?.addEventListener('click',()=>this.goToNext());this.container.addEventListener('mouseenter',()=>this.pauseAutoplay());this.container.addEventListener('mouseleave',()=>this.resumeAutoplay());this.container.addEventListener('focusin',()=>this.pauseAutoplay());this.container.addEventListener('focusout',()=>this.resumeAutoplay());this.setupTouchEvents();this.container.addEventListener('keydown',(e)=>this.handleKeydown(e))}setupTouchEvents(){let startX=0;let startY=0;let isDragging=false;let currentTranslateX=0;this.track.addEventListener('touchstart',(e)=>{startX=e.touches[0].clientX;startY=e.touches[0].clientY;isDragging=true;currentTranslateX=0;this.pauseAutoplay();this.track.classList.add('touch-active')},{passive:true});this.track.addEventListener('touchmove',(e)=>{if (!isDragging)return;const currentX=e.touches[0].clientX;const currentY=e.touches[0].clientY;const diffX=startX-currentX;const diffY=startY-currentY;if (Math.abs(diffX)>Math.abs(diffY)){e.preventDefault();currentTranslateX=-diffX;const maxSwipe=window.innerWidth*0.3;currentTranslateX=Math.max(-maxSwipe,Math.min(maxSwipe,currentTranslateX));this.track.style.transform=`translateX(${currentTranslateX}px)`}},{passive:false});this.track.addEventListener('touchend',(e)=>{if (!isDragging)return;const endX=e.changedTouches[0].clientX;const diffX=startX-endX;const threshold=50;this.track.classList.remove('touch-active');this.track.style.transform='';this.track.style.transition='';if (Math.abs(diffX)>threshold){if (this.isRTL){if (diffX>0){this.goToNext()}else{this.goToPrevious()}}else{if (diffX>0){this.goToNext()}else{this.goToPrevious()}}}isDragging=false;this.resumeAutoplay()},{passive:true})}setupAccessibility(){this.updateAriaStates();if (this.track){this.track.setAttribute('tabindex','0');this.track.setAttribute('role','group');this.track.setAttribute('aria-label','קרוסלת המלצות')}}handleKeydown(e){switch(e.key){case 'ArrowLeft':e.preventDefault();this.isRTL ? this.goToNext():this.goToPrevious();break;case 'ArrowRight':e.preventDefault();this.isRTL ? this.goToPrevious():this.goToNext();break;case 'Home':e.preventDefault();this.goToSlide(0);break;case 'End':e.preventDefault();this.goToSlide(this.totalCards-1);break}}goToNext(){if (this.isAnimating)return;this.currentIndex=(this.currentIndex+1)% this.totalCards;this.slideToCurrentIndex()}goToPrevious(){if (this.isAnimating)return;this.currentIndex=(this.currentIndex-1+this.totalCards)% this.totalCards;this.slideToCurrentIndex()}goToSlide(index){if (this.isAnimating||index===this.currentIndex)return;this.currentIndex=index;this.slideToCurrentIndex()}createAllCards(){if (!this.track)return;this.track.innerHTML='';this.allCards=[];testimonialsData.forEach((data,index)=>{const cardElement=document.createElement('div');cardElement.className='testimonial-card';cardElement.dataset.testimonialIndex=index;cardElement.innerHTML=this.createTestimonialCardHTML(data,index);this.track.appendChild(cardElement);this.allCards.push(cardElement)})}createTestimonialCardHTML(data,index){const starsHTML=Array(data.stars).fill('<i class="fas fa-star"></i>').join('');return `<div class="testimonial-content"><div class="stars">${starsHTML}</div><p>"${data.text}"</p></div><div class="testimonial-author"><div class="author-icon"><i class="fas fa-user-circle"></i></div><div class="author-info"><h3>${data.author}</h3><span>${data.event}</span></div></div>`}updateLayout(){const isMobile=window.innerWidth<this.mobileBreakpoint;this.visibleCards=isMobile ? 1:3;if (!isMobile){this.updateDesktopCards()}const containerWidth=this.container.offsetWidth;const padding=isMobile ? 20:112;const gap=20;this.cardWidth=(containerWidth-padding-(gap*(this.visibleCards-1)))/this.visibleCards;this.allCards.forEach((card,index)=>{card.style.minWidth=`${this.cardWidth}px`;card.style.maxWidth=`${this.cardWidth}px`;card.style.flex='none'});this.slideToCurrentIndex(false)}slideToCurrentIndex(animate=true){if (!this.track||this.allCards.length===0)return;this.isAnimating=animate;const isMobile=window.innerWidth<this.mobileBreakpoint;let offset=0;if (isMobile){offset=this.currentIndex*(this.cardWidth+20)}else{this.updateDesktopCards();offset=0}const translateX=this.isRTL ? offset:-offset;if (animate&&!this.prefersReducedMotion){this.track.style.transition='transform 0.5s cubic-bezier(0.4,0,0.2,1)'}else{this.track.style.transition='none'}this.track.style.transform=`translateX(${translateX}px)`;this.updateAriaStates();this.announceSlide();if (animate){setTimeout(()=>{this.isAnimating=false},500)}else{this.isAnimating=false}}updateDesktopCards(){const isMobile=window.innerWidth<this.mobileBreakpoint;if (isMobile||this.allCards.length<3)return;while (this.allCards.length>3){const cardToRemove=this.allCards.pop();if (cardToRemove&&cardToRemove.parentNode){cardToRemove.parentNode.removeChild(cardToRemove)}}while (this.allCards.length<3){const cardElement=document.createElement('div');cardElement.className='testimonial-card';this.track.appendChild(cardElement);this.allCards.push(cardElement)}for (let i=0;i<3;i++){const testimonialIndex=(this.currentIndex+i)% this.totalCards;const data=testimonialsData[testimonialIndex];if (this.allCards[i]&&data){this.allCards[i].dataset.testimonialIndex=testimonialIndex;this.allCards[i].innerHTML=this.createTestimonialCardHTML(data,testimonialIndex)}}}updateAriaStates(){const currentCards=this.container.querySelectorAll('.testimonial-card');currentCards.forEach((card)=>{card.setAttribute('aria-hidden',false)})}announceSlide(){const announcement=`המלצה ${this.currentIndex+1}מתוך ${this.totalCards}`;let liveRegion=this.container.querySelector('.sr-only');if (!liveRegion){liveRegion=document.createElement('div');liveRegion.className='sr-only';liveRegion.setAttribute('aria-live','polite');liveRegion.style.cssText='position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;';this.container.appendChild(liveRegion)}liveRegion.textContent=announcement}startAutoplay(){if (!this.autoAdvance)return;this.autoplayTimer=setInterval(()=>{this.goToNext()},this.interval)}pauseAutoplay(){if (this.autoplayTimer){clearInterval(this.autoplayTimer);this.autoplayTimer=null}}resumeAutoplay(){if (this.autoAdvance&&!this.autoplayTimer){this.startAutoplay()}}debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}destroy(){this.pauseAutoplay();this.container=null;this.track=null}}class Chatbot{constructor(){this.chatWidget=document.getElementById('chatbot-widget');this.chatToggle=document.getElementById('chat-toggle');this.chatModal=document.getElementById('chat-modal');this.chatClose=document.getElementById('chat-close');this.chatMessages=document.getElementById('chat-messages');this.chatInputField=document.getElementById('chat-input-field');this.chatSend=document.getElementById('chat-send');this.chatTyping=document.getElementById('chat-typing');this.chatTooltip=document.getElementById('chat-tooltip');this.isOpen=false;this.isTyping=false;this.API_BASE_URL='https://singwithalon-ai-chat-production.up.railway.app';this.USE_BACKEND_API=true;this.sessionMessageCount=0;this.MAX_MESSAGES_PER_SESSION=10;this.sessionId=this.getOrCreateSessionId();this.conversationHistory=[];if (this.chatWidget&&this.chatToggle&&this.chatModal){this.init()}else{console.warn('Chatbot elements not found,skipping initialization')}}init(){this.setupEventListeners();this.setupSuggestions();this.enableInputValidation();this.setupTooltipIntroduction();this.setupPeriodicGlowEffect()}getOrCreateSessionId(){const sessionId=this.generateSessionId();localStorage.setItem('chat_session_id',sessionId);return sessionId}generateSessionId(){return 'session_'+Date.now()+'_'+Math.random().toString(36).substr(2,9)}canSendMessage(){return this.sessionMessageCount<this.MAX_MESSAGES_PER_SESSION}setupEventListeners(){if (this.chatToggle){this.chatToggle.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();if (!this.chatToggle.disabled){this.toggleChat()}})}if (this.chatClose){this.chatClose.addEventListener('click',()=>{this.closeChat()})}if (this.chatSend){this.chatSend.addEventListener('click',()=>{this.sendMessage()})}if (this.chatInputField){this.chatInputField.addEventListener('keypress',(e)=>{if (e.key==='Enter'&&!e.shiftKey&&this.chatInputField.value.trim()){e.preventDefault();this.sendMessage()}})}document.addEventListener('click',(e)=>{if (this.isOpen&&!this.chatWidget.contains(e.target)){this.closeChat()}});document.addEventListener('keydown',(e)=>{if (e.key==='Escape'&&this.isOpen){this.closeChat()}})}setupSuggestions(){document.querySelectorAll('.suggestion-btn').forEach(btn=>{btn.addEventListener('click',()=>{const question=btn.textContent;this.chatInputField.value=question;this.sendMessage()})})}enableInputValidation(){if (this.chatInputField&&this.chatSend){this.chatInputField.addEventListener('input',()=>{const hasText=this.chatInputField.value.trim().length>0;this.chatSend.disabled=!hasText||this.isTyping||!this.canSendMessage()})}}toggleChat(){if (this.isOpen){this.closeChat()}else{this.openChat()}}openChat(){if (this.isOpen)return;this.isOpen=true;if (this.chatToggle){this.chatToggle.disabled=true;this.chatToggle.classList.add('active');setTimeout(()=>{this.chatToggle.disabled=false},300)}if (this.chatModal)this.chatModal.classList.add('open');setTimeout(()=>{if (this.chatInputField)this.chatInputField.focus()},300)}closeChat(){if (!this.isOpen)return;this.isOpen=false;if (this.chatToggle){this.chatToggle.disabled=true;this.chatToggle.classList.remove('active');setTimeout(()=>{this.chatToggle.disabled=false},300)}if (this.chatModal)this.chatModal.classList.remove('open')}sendMessage(){if (!this.chatInputField)return;const text=this.chatInputField.value.trim();if (!text||this.isTyping)return;if (!this.canSendMessage()){this.addMessage('מצטער,הגעתם למגבלת 10 הודעות לשיחה. אשמח אם תצרו קשר ישירות בוואטסאפ:052-896-2110','bot');this.disableChatInput();return}this.sessionMessageCount++;if (this.sessionMessageCount>=this.MAX_MESSAGES_PER_SESSION){setTimeout(()=>{this.disableChatInput()},2000)}this.addMessage(text,'user');this.chatInputField.value='';if (this.chatSend)this.chatSend.disabled=true;this.conversationHistory.push({role:'user',parts:[{text:text}]});this.showTyping();this.getAIResponse(text)}addMessage(text,sender){if (!this.chatMessages)return;const messageDiv=document.createElement('div');messageDiv.className=`message ${sender}-message`;const time=new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});const avatar=sender==='bot' ? '<div class="message-avatar"><i class="fas fa-music"></i></div>':'<div class="message-avatar"><i class="fas fa-user"></i></div>';const processedText=sender==='bot' ? this.processTextForLinks(text):text;messageDiv.innerHTML=` ${avatar}<div class="message-content"><p>${processedText}</p><span class="message-time">${time}</span></div>`;this.chatMessages.appendChild(messageDiv);this.scrollToBottom()}showTyping(){this.isTyping=true;if (this.chatTyping)this.chatTyping.style.display='flex';if (this.chatSend)this.chatSend.disabled=true;this.scrollToBottom()}hideTyping(){this.isTyping=false;if (this.chatTyping)this.chatTyping.style.display='none';if (this.chatSend&&this.chatInputField){this.chatSend.disabled=this.chatInputField.value.trim().length===0||!this.canSendMessage()}}scrollToBottom(){if (this.chatMessages){setTimeout(()=>{this.chatMessages.scrollTop=this.chatMessages.scrollHeight},100)}}disableChatInput(){if (this.chatInputField){this.chatInputField.disabled=true;this.chatInputField.placeholder='הגעתם למגבלת 10 הודעות-צרו קשר בוואטסאפ'}if (this.chatSend){this.chatSend.disabled=true}}isMobileDevice(){return/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}processTextForLinks(text){const isMobile=this.isMobileDevice();const phonePattern=/(0\d{1,2}-?\d{3}-?\d{4})/g;const whatsappPattern=/(https?:\/\/(?:wa\.me|api\.whatsapp\.com)\/[^\s]+)/g;let processedText=text;processedText=processedText.replace(whatsappPattern,(match)=>{if (isMobile){return `<a href="${match}" target="_blank" style="color:#25D366;text-decoration:underline;">צור קשר בוואטסאפ</a>`}else{return `<a href="${match}" target="_blank" style="color:#25D366;text-decoration:underline;">צור קשר בוואטסאפ</a>`}});processedText=processedText.replace(phonePattern,(match)=>{const cleanPhone=match.replace(/-/g,'');if (isMobile){return `<a href="tel:${cleanPhone}" style="color:#007bff;text-decoration:underline;">${match}</a>`}else{return `<span style="color:#007bff;font-weight:bold;">${match}</span>`}});return processedText}async getAIResponse(userMessage){if (this.USE_BACKEND_API){await this.getBackendResponse(userMessage)}else{await this.getFallbackResponse(userMessage)}}async getBackendResponse(userMessage){try{const requestBody={messages:this.conversationHistory,session_id:this.sessionId};const timeoutPromise=new Promise((_,reject)=>setTimeout(()=>reject(new Error('Request timeout')),10000));const fetchPromise=fetch(`${this.API_BASE_URL}/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(requestBody)});const response=await Promise.race([fetchPromise,timeoutPromise]);if (!response.ok){throw new Error(`Backend API Error:${response.status}`)}const data=await response.json();if (data.session_id&&data.session_id!==this.sessionId){this.sessionId=data.session_id;localStorage.setItem('chat_session_id',this.sessionId)}this.conversationHistory.push({role:'assistant',parts:[{text:data.response}]});if (this.conversationHistory.length>10){this.conversationHistory=this.conversationHistory.slice(-8)}this.hideTyping();this.addMessage(data.response,'bot')}catch (error){console.error('Backend API Error:',error);this.hideTyping();if (error.message.includes('429')){this.addMessage('הגעתם למגבלת ההודעות השעתית. אשמח אם תצרו קשר ישירות בוואטסאפ:052-896-2110','bot')}else if (error.message.includes('500')){this.addMessage('יש בעיה זמנית במערכת. אני זמין בוואטסאפ לכל שאלה:052-896-2110','bot')}else{await this.getFallbackResponse(userMessage)}}}async getFallbackResponse(userMessage){const responses={'מה כלול במופע אינטראקטיבי':'במופע האינטראקטיבי שלי כלול:מערכת בחירת שירים בזמן אמת,ליווי מוזיקלי מלא,מיקרופונים אלחוטיים לקהל,הקרנת מילים,והגברה מקצועית. הקהל בוחר מתוך מאות שירים ברפרטואר!','כמה עולה מופע':'המחיר תלוי במספר גורמים כמו מספר האורחים,משך הזמן,והמיקום. אשמח לתת לכם הצעת מחיר מדויקת לאחר שתספרו לי על האירוע שלכם. בואו נעבור לוואטסאפ לפרטים? 052-896-2110','איך פועלת מערכת בחירת השירים':'המערכת שלי פשוטה וכיפית!האורחים נכנסים לאתר באמצעות QR קוד,רואים רשימה של מאות שירים לבחירה,ובוחרים את השירים שהם הכי אוהבים. אני רואה את הבקשות בזמן אמת ובונה את המופע בהתאם!','default':[ 'אשמח לעזור לכם עם האירוע!בואו נדבר יותר בפירוט בוואטסאפ:052-896-2110','שאלה מעולה!אני זמין לענות על כל השאלות שלכם בוואטסאפ:052-896-2110','אשמח לעזור לכם לתכנן את האירוע המושלם!בואו נמשיך בוואטסאפ:052-896-2110' ]};await new Promise(resolve=>setTimeout(resolve,1000+Math.random()*1000));const lowerMessage=userMessage.toLowerCase();let response=null;for (const [key,responseText] of Object.entries(responses)){if (key!=='default'&&lowerMessage.includes(key)){response=responseText;break}}if (!response){if (lowerMessage.includes('מחיר')||lowerMessage.includes('עולה')||lowerMessage.includes('עלות')){response=responses['כמה עולה מופע']}else if (lowerMessage.includes('שיר')||lowerMessage.includes('רפרטואר')||lowerMessage.includes('מוזיקה')){response='ברפרטואר שלי יש מאות שירים מכל התקופות:שירי ארץ ישראל הישנים,שלמה ארצי,יהורם גאון,הדודאים,עד שירים מודרניים יותר. במערכת האינטראקטיבית האורחים יכולים לראות את כל הרשימה ולבחור!'}}if (!response){const defaultResponses=responses['default'];response=defaultResponses[Math.floor(Math.random()*defaultResponses.length)]}this.hideTyping();this.addMessage(response,'bot')}setupTooltipIntroduction(){if (!this.chatTooltip)return;setTimeout(()=>{this.chatTooltip.classList.add('show');setTimeout(()=>{this.chatTooltip.classList.remove('show')},3000)},3000);this.chatToggle.addEventListener('click',()=>{this.chatTooltip.classList.remove('show')})}setupPeriodicGlowEffect(){setInterval(()=>{if (!this.isOpen){this.chatToggle.classList.add('glow-effect');setTimeout(()=>{this.chatToggle.classList.remove('glow-effect')},1500)}},8000)}}document.addEventListener('DOMContentLoaded',()=>{new MusicianSite();new Chatbot();PerformanceUtils.lazyLoadImages();PerformanceUtils.preloadCriticalImages();setTimeout(()=>{document.body.classList.add('loaded')},100)});document.addEventListener('visibilitychange',()=>{if (document.hidden){const videos=document.querySelectorAll('video');videos.forEach(video=>{if (!video.paused){video.pause();video.dataset.wasPlaying='true'}})}else{const videos=document.querySelectorAll('video[data-was-playing="true"]');videos.forEach(video=>{video.play();delete video.dataset.wasPlaying})}});window.addEventListener('resize',()=>{if (window.innerWidth>768){const navMenu=document.getElementById('nav-menu');const hamburger=document.getElementById('hamburger');if (navMenu&&hamburger){navMenu.classList.remove('active');hamburger.classList.remove('active')}}});